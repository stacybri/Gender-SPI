---
title: 'Measuring the Availability of Gender Data using the Statistical Performance Indicators (SPI) Framework'
author: ""
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    toc: yes
    fig_width: 9
    fig_height: 6
abstract: ''
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.height = 6,
	fig.path = "plots/",
	fig.width = 9,
	message = FALSE,
	warning = FALSE,
	dev = c("png"),
	dpi = 350
)
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
library(fixest)
library(modelsummary)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population (2))
wgt <- 1

```

```{r programs}

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% 
    autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(data) {
  eq <- lm_robust(outcome ~ availability, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}

#add equations to plots
eq_plot_txt_reverse <- function(data) {
  eq <- lm_robust(availability ~ outcome, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}
```

```{r themes}

#ggplot theme
theme_spi <- function () { 
    theme_bw() %+replace%
    theme(
      plot.caption = element_text(hjust = 0),
      plot.title=element_blank() #remove all titles from plots (sometimes we may need to bring title outside plot)
    )
}

#modelsummary output
gm <- tibble::tribble(
  ~raw,        ~clean,          ~fmt,
  "nobs",      "N",             0,
  "r.squared", "R Sq.", 2)
```


# Introduction

The [2030 Agenda for Sustainable Development](https://sdgs.un.org/2030agenda) lays out an ambitious agenda for achieving gender equality and empowering all women and girls. This agenda, adopted by nearly all countries, is paired with a set of goals and targets, with concrete indicators, for meeting that agenda.

However, countries are falling short on reporting on these indicators.  This article will diagnose the reasons for missing gender data: (1) lack of core/foundational surveys/census or relevant admin data source (2) lack of specialized surveys (3) flawed surveys/MIS (questionnaire design or bad forms in admin data) (4) lack of availability of data/stats from surveys/census/admin sources – so data exists but not easy to get the data/stats [poorly disseminated].

To begin, a discussion of the scope of missing data is given.  Data is largely sourced from the UN Global SDG database.  A set of roughly 91 indicators are investigated which are either part of SDG 5 on gender equity, or else are an SDG indicator that calls for a specific breakdown by sex.  

Next, for each country, the share of these indicators that are available over a five year period from 2015 to 2020 are assessed.  Globally, countries have a value for less than 40% of these indicators on average during this time period.  For tier 1 indicators, the average is slightly higher with countries having a recent value for around 44% of the indicators.  For tier 2 indicators, the average country has a recent value for only 27% of the indicators.  For Goal 5 specifically, the average country has a recent value for around 34% of the indicators.

Additionally, for indicators that require a breakdown by sex, in several cases there are large gaps between the percentage of countries with a recent value for females and whether a value for any sex or both sexes combined exists.  For instance, while SDG indicator 1.2.1, on the proportion of population living below the national poverty line, specifies that a breakdown by sex is available.  This information is not currently available in the UN global SDG database.  Additionally, for SDG indicator 1.3.1, on Proportion of population covered by social protection floors/systems, by sex, 79.4% of countries have a recent value for any/both sexes, but only 7.8% of countries have a recent value for females.  To cite another example, for SDG indicator 4.1.1, Proportion of children and young people (a) in grades 2/3; (b) at the end of primary; and (c) at the end of lower secondary achieving at least a minimum proficiency level in (i) reading and (ii) mathematics, by sex, 62.4% of countries have a value for any/both sexes, but only 52.3% of countries have a value for females.

This paper then offers a discussion for why such gender gaps exist.  First, the relationship between a country's Statistical Performance Indicator (SPI) overall score and the country's performance at producing gender statistics is examined. Next, the specific set of data sources used to produce gender SDG indicators is examined.  


## SDG Indicators related to Gender

```{r sdggendf}
#read in table about gender sdgs
sdg_tab <- read_csv(file = paste0(raw_dir, '/misc/Gender_SDGs.csv')) 

sdg_tab_merge <- sdg_tab %>%
  #filter(!is.na(Code)) %>%
  transmute(ccode=ccode,
            code1=Code,
            code=SDG)

#get a list of all SDG indicators
indicators_url <- 'https://unstats.un.org/SDGAPI/v1/sdg/Indicator/List?pageSize=10000'

indicators_list <- sdg_tab %>%
  filter(!is.na(Code))

indicators_list <- indicators_list$Code


#bring in the list of indicators
list_df <- jsonlite::fromJSON(indicators_url, flatten = TRUE) %>%
  as_tibble() %>%
  unnest(keep_empty = TRUE)

list_df <- sdg_tab_merge %>%
  left_join(list_df) %>%
  #filter(tier<=2) %>% # keep just the tier 1 indicators %>%
  #filter(code1 %in% indicators_list) 
  filter(!is.na(ccode)) 

# get list of tier 1 indicaors
tier1_list <- list_df %>%
  filter(tier==1)

tier1_list <- tier1_list$code1

# get list of tier 2 indicaors
tier2_list <- list_df %>%
  filter(tier==2)

tier2_list <- tier2_list$code1

#get goal
sdg_tab$Goal <- as.character(map(strsplit(sdg_tab$SDG, split = "\\."), 1))

gend_df_len <- nrow(list_df)

```


Below is a list of SDG indicators related to gender.  These indicators include both the indicators in SDG 5 on gender equity, as well as indicators from several other goals that specify that an indicator should be available by gender.  For instance SDG indicator 8.5.2 specified that countries should track the unemployment rate, by sex, age and persons with disabilities.  In what will follow, it will be checked whether data is available in each country for these indicators. There are `r gend_df_len` indicators that are identified.

So as to judge countries by a set of indicators that are on the most solid foundation and widespread, the table includes only [tier 1 & tier 2 indicators](https://unstats.un.org/sdgs/iaeg-sdgs/tier-classification/). Tier 1 indicators, according to the UN, are indicators that are conceptually clear, have an internationally established methodology and standards available, and data are regularly produced by countries for at least 50% of countries and of the population in every region where relevant.  Tier 2 indicators are conceptually clear and have an internationally established methodology and set of standards, but are not regularly produced by countries.

```{r sdggender}

# list_df %>%
#   transmute(
#     Goal=goal,
#     Indicator=code,
#     Description=description,
#     Tier=tier
#   ) %>%
#   distinct() %>%
#   flextable() %>%
#     add_header_lines('Table 1. SDG Indicators Related to Gender') %>%
#     merge_v(j='Goal') %>%
#     theme_vanilla() %>%
#     add_footer_lines(values = "Source: UN."                 ) %>%
#   FitFlextableToPage() %>%
#     autofit()
  

table1dat <- list_df %>%
   transmute(
    ccode=ccode,
    Goal=goal,
    Indicator=code,
    Description=description,
    Tier=tier,
    `Sub-Description`=description1
  ) %>%
  group_by(ccode, Goal, Indicator, Description, Tier) %>%
  summarise(`Sub-Indicators`=paste(`Sub-Description`,collapse="; /n ")) %>%
  distinct() %>%
  select(-ccode)

```

## Coverage Gaps for Gender Indicators

In the following section, a discussion will be given on the current availability of gender data. Particular attention is given to the availability of data for reporting on the Sustainable Development Goals (SDGs), as it represents an agreed upon set of goals for countries to meet and because the vast majority of countries, through the SDG dialogue, have agreed to report on indicators related to these goals. Coverage gaps across regions, income groups, ages, and years are discussed.

While nearly all countries have agreed to report on the SDG indicator, and according to the [UN global SDG indicators database](https://unstats.un.org/sdgs/indicators/database/) major gaps exist in what indicators are available.  The UN global SDG indicators database provides access to the data compiled by the UN for the annual [Sustainable Development Goals Report](https://www.un.org/sustainabledevelopment/progress-report/) tracking progress toward fulfilling the SDGs [@un2020].  

The methodology for this exercise follows [@dang2020tracking], which summarises the availability of SDG indicators in the UN SDG database.  For each SDG indicator, a country scores "1" if a value can be found in the database for that indicator between 2010 and 2020, and "0" if data is missing for that indicator between 2010 and 2020.  The value for the region and income group in Figure 1 and Figure 2 below is the percentage of countries in that region or income group with a value found in the database.  The percentages are raw percentages across regions or income groups and are not weighted for population.  Only tier 1 indicators are included in this analysis.

### Methodology

  1. Download the latest SDG indicator data from UN Stats (https://unstats.un.org/sdgs/indicators/en/#) using their API   
  
  2. Transform the data so that for each indicator we can create a score documenting whether a value exists for the country in a year, whether the value is based on country data, country data adjusted, estimated, or modelled data according the UN Stats metadata. **This will only include tier 1 indicators**.    
  
  3. Combine the resulting data into a single set of indicators by calculating the average across the gender SDGs.  

Below is a paraphrased description from the UN stats webpage (https://unstats.un.org/sdgs/indicators/indicators-list/):

The global indicator framework for Sustainable Development Goals was developed by the Inter-Agency and Expert Group on SDG Indicators (IAEG-SDGs) and agreed upon at the 48th session of the United Nations Statistical Commission held in March 2017.

The global indicator framework includes 231 unique indicators. Please note that the total number of indicators listed in the global indicator framework of SDG indicators is 247. However, twelve indicators repeat under two or three different targets.

For each value of the indicator, the responsible international agency has been requested to indicate whether the national data were adjusted, estimated, modelled or are the result of global monitoring. The “nature” of the data in the SDG database is determined as follows:


  * Country data (C): Produced and disseminated by the country (including data adjusted by the country to meet international standards);    
  
  * Country data adjusted (CA): Produced and provided by the country, but adjusted by the international agency for international comparability to comply with internationally agreed standards, definitions and classifications;    
  
  * Estimated (E): Estimated based on national data, such as surveys or administrative records, or other sources but on the same variable being estimated, produced by the international agency when country data for some year(s) is not available, when multiple sources exist, or when there are data quality issues;    
  
  * Modelled (M): Modelled by the agency on the basis of other covariates when there is a complete lack of data on the variable being estimated;    
  
  * Global monitoring data (G): Produced on a regular basis by the designated agency for global monitoring, based on country data. There is no corresponding figure at the country level.


For each indicator, we will produce a value for each country with the following coding scheme:    

  * **1 Point**: Indicator exists and the value is based on the **country**, **country data adjusted**, or **estimated or Global Monitoring** data    
  * **0 Points**: Indicator **based on modeled data or does not exists**
  
We give countries no credit for modeled data, because the country did not produce indicators in a form that was directly usable for reporting on an SDG indicator.
  
When we average over all indicators in a goal to get a score, we compute a 5 year moving average to avoid year to year variability in reporting for SDGs.  The overall score for an SDG is then the 5 year average of the percentage of indicator values based on **country**, **country data adjusted**, or **estimated or Global Monitoring** data that were available for the SDG.

```{r save, echo=FALSE, message=FALSE, warning=FALSE}

country_metadata <- wbstats::wb_countries() %>%
  filter(region!="Aggregates")

#remove this dataframe if it exists
if (exists('un_sdg_df')) {
  rm(un_sdg_df)
}

for (series in list_df$code1) {
    
  #read in files
  if (file.exists(paste(raw_dir,'/sdg_data/',series,'.csv',sep=""))) {
    temp <- read_csv(paste(raw_dir,'/sdg_data/',series,'.csv',sep="")) %>%
      mutate(
        date=as.numeric(date), 
        goal=as.character(goal), 
        target=as.character(target), 
        code==as.character(code), 
        code1=as.character(code1), 
        description1=as.character(description1)
      )
    
    #   #now append it to the overall database
    if (!exists('un_sdg_df')) {
      un_sdg_df <- temp
    } else if (exists('un_sdg_df')) {
      un_sdg_df <- un_sdg_df %>%
        bind_rows(temp)
    }
  }
  
}

#remove this dataframe if it exists
if (exists('un_sdg_meta')) {
  rm(un_sdg_meta)
}

for (series in list_df$code1) {
    
  #read in files
  if (file.exists(paste(raw_dir,'/sdg_data/',series,'.csv',sep=""))) {
   
    tempmeta <- read_csv(paste(raw_dir,'/sdg_data/',series,'.csv',sep="")) %>%
    filter(!is.na(ind_value)) %>%
    group_by(ind_metadata, code1) %>%
    summarise(n = n()) %>%
    ungroup() %>%
    mutate(tot = sum(n),
           source_share = round(100*n/tot, 1),
           ind_metadata=as.character(ind_metadata))
    
    #   #now append it to the overall database
    if (!exists('un_sdg_meta')) {
      un_sdg_meta <- tempmeta
    } else if (exists('un_sdg_meta')) {
      un_sdg_meta <- un_sdg_meta %>%
        bind_rows(tempmeta)
    }
  }
  
}

 un_sdg_meta_wide <- un_sdg_meta %>%
  filter(!is.na(ind_metadata)) %>%
   group_by(code1, ind_metadata) %>%
   summarise(source_share = mean(source_share)) %>%
   spread(ind_metadata, source_share) %>%
   mutate_all(as.character) %>%
  mutate(source_share = paste0("C: (", C, "), CA: (", CA, "), E: (", E, "), G: (", G, "), M: (", M, ")"),
         source_share = gsub("NA", "", source_share)) %>%
   select(code1, source_share)
  

#read in OECD data for updates based on OECD database
oecd_df <- read_csv(paste(raw_dir,'/oecd_data/OECD_data_scored.csv', sep=""))

un_sdg_df <- un_sdg_df %>%
  mutate(goal=as.numeric(goal)) %>%
  left_join(oecd_df) %>%
  mutate(goal=as.character(goal)) %>%
  mutate(ind_quality=if_else(ind_quality.oecd>ind_quality,ind_quality.oecd,ind_quality, ind_quality )) #replace value with OECD value if it exists

#save the data file
  
write_excel_csv(un_sdg_df, paste(output_dir, '/un_sdg_df.csv',sep=""))


```


```{r saver, eval=FALSE, include=FALSE}

#function to create scored data


un_aki_fun <- function(date_start, date_end) {
  
  global <- un_sdg_df %>%
    left_join(sdg_tab_merge) %>% #merge on special code for aggregating
    filter(between(date,date_start,date_end) ) %>%
    filter(!is.na(ind_quality)) %>%
    group_by(iso3c, ccode,goal) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T),
              ind_value=mean(ind_value, na.rm=T),
              ind_metadata=first(ind_metadata)) %>% #check if any values (even sub-indicators) for indicator
      mutate(ind_quality=if_else(is.na(ind_quality),0,ind_quality)) %>% # if the indicator is missing for a year in the database, set availability to 0.
      group_by(iso3c) %>%
      summarise(ind_quality=round(mean(ind_quality),3) #get whether indicator exists at all in 5 years of this across countries
              ) %>%
    left_join(country_metadata) %>%
    filter(!is.na(region)) %>%
    select(iso3c, country,region, income_level, ind_quality) %>%
    mutate(date=date_end,
           goal="Combined")
  
    tier1 <- un_sdg_df %>%
      left_join(sdg_tab_merge) %>% #merge on special code for aggregating
      filter(between(date,date_start,date_end) ) %>%
      filter(!is.na(ind_quality)) %>%
      filter(code1 %in% tier1_list) %>% #get just tier1 indicators  
      group_by(iso3c, ccode,goal) %>%
      summarise(ind_quality=max(ind_quality, na.rm=T),
                ind_value=mean(ind_value, na.rm=T),
                ind_metadata=first(ind_metadata)) %>% #check if any values (even sub-indicators) for indicator
        mutate(ind_quality=if_else(is.na(ind_quality),0,ind_quality)) %>% # if the indicator is missing for a year in the database, set availability to 0.
        group_by(iso3c) %>%
        summarise(ind_quality=round(mean(ind_quality),3) #get whether indicator exists at all in 5 years of this across countries
                ) %>%
      left_join(country_metadata) %>%
      filter(!is.na(region)) %>%
      select(iso3c, country,region, income_level, ind_quality) %>%
      mutate(date=date_end,
             goal="Tier 1")
    
    tier2 <- un_sdg_df %>%
      left_join(sdg_tab_merge) %>% #merge on special code for aggregating
      filter(between(date,date_start,date_end) ) %>%
      filter(!is.na(ind_quality)) %>%
      filter(code1 %in% tier2_list) %>% #get just tier1 indicators  
      group_by(iso3c, ccode,goal) %>%
      summarise(ind_quality=max(ind_quality, na.rm=T),
                ind_value=mean(ind_value, na.rm=T),
                ind_metadata=first(ind_metadata)) %>% #check if any values (even sub-indicators) for indicator
        mutate(ind_quality=if_else(is.na(ind_quality),0,ind_quality)) %>% # if the indicator is missing for a year in the database, set availability to 0.
        group_by(iso3c) %>%
        summarise(ind_quality=round(mean(ind_quality),3) #get whether indicator exists at all in 5 years of this across countries
                ) %>%
      left_join(country_metadata) %>%
      filter(!is.na(region)) %>%
      select(iso3c, country,region, income_level, ind_quality) %>%
      mutate(date=date_end,
             goal="Tier 2")
  
   goal <- un_sdg_df %>%
    left_join(sdg_tab_merge) %>% #merge on special code for aggregating
    filter(between(date,date_start,date_end) ) %>%
    filter(!is.na(ind_quality)) %>%
    group_by(iso3c, ccode,goal) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T),
              ind_value=mean(ind_value, na.rm=T),
              ind_metadata=first(ind_metadata)) %>% #check if any values (even sub-indicators) for indicator
      mutate(ind_quality=if_else(is.na(ind_quality),0,ind_quality)) %>% # if the indicator is missing for a year in the database, set availability to 0.
      group_by(iso3c,goal) %>%
      summarise(ind_quality=round(mean(ind_quality),3) #get whether indicator exists at all in 5 years of this across countries
              ) %>%
    left_join(country_metadata) %>%
    filter(!is.na(region)) %>%
    select(iso3c, country,region, income_level,goal, ind_quality) %>%
    mutate(date=date_end
           ) 
   
  global %>%
    bind_rows(tier1) %>%
    bind_rows(tier2) %>%
    bind_rows(goal) %>%
    select(iso3c,date, country,region, income_level,goal, ind_quality)
  
}


####
# 10 Year window
####
#create this database for each year from 2004 to 2020 using a 5 year average
for (i in c(2009:2020)) {
  
  start=i-9
  end=i
  
  temp_df <- un_aki_fun(start,end)
  assign(paste('un_aki_',end, sep=""), temp_df)
}

if (exists('un_aki')) {
  rm('un_aki')
}
#now append together and save
for (i in c(2009:2020)) {
  
  temp<-get(paste('un_aki_',i, sep=""))
  
  if (!exists('un_aki')) {
    un_aki<-temp 
  } else {
    un_aki<-un_aki %>%
      bind_rows(temp) %>%
      arrange(-date, iso3c)
  }
}

write_excel_csv(un_aki, path=paste(output_dir, 'SPI_Gender_UNSD_data_10yr.csv', sep="/"))

####
# 8 Year window
####
#create this database for each year from 2004 to 2020 using a 5 year average
for (i in c(2007:2020)) {
  
  start=i-7
  end=i
  
  temp_df <- un_aki_fun(start,end)
  assign(paste('un_aki_',end, sep=""), temp_df)
}

if (exists('un_aki')) {
  rm('un_aki')
}
#now append together and save
for (i in c(2007:2020)) {
  
  temp<-get(paste('un_aki_',i, sep=""))
  
  if (!exists('un_aki')) {
    un_aki<-temp
  } else {
    un_aki<-un_aki %>%
      bind_rows(temp) %>%
      arrange(-date, iso3c)
  }
}

write_excel_csv(un_aki, path=paste(output_dir, 'SPI_Gender_UNSD_data_8yr.csv', sep="/"))

####
# 5 Year window
####
#create this database for each year from 2004 to 2020 using a 5 year average
for (i in c(2004:2020)) {
  
  start=i-4
  end=i
  
  temp_df <- un_aki_fun(start,end)
  assign(paste('un_aki_',end, sep=""), temp_df)
}

if (exists('un_aki')) {
  rm('un_aki')
}
#now append together and save
for (i in c(2004:2020)) {
  
  temp<-get(paste('un_aki_',i, sep=""))
  
  if (!exists('un_aki')) {
    un_aki<-temp
  } else {
    un_aki<-un_aki %>%
      bind_rows(temp) %>%
      arrange(-date, iso3c)
  }
}
write_excel_csv(un_aki, path=paste(output_dir, 'SPI_Gender_UNSD_data_5yr.csv', sep="/"))

write_excel_csv(un_aki, path=paste(output_dir, 'SPI_Gender_UNSD_data_rev_5yr.csv', sep="/"))
####
# 3 Year window
####
#create this database for each year from 2004 to 2020 using a 5 year average
for (i in c(2004:2020)) {
  
  start=i-2
  end=i
  
  temp_df <- un_aki_fun(start,end)
  assign(paste('un_aki_',end, sep=""), temp_df)
}

if (exists('un_aki')) {
  rm('un_aki')
}
#now append together and save
for (i in c(2004:2020)) {
  
  temp<-get(paste('un_aki_',i, sep=""))
  
  if (!exists('un_aki')) {
    un_aki<-temp
  } else {
    un_aki<-un_aki %>%
      bind_rows(temp) %>%
      arrange(-date, iso3c)
  }
}

write_excel_csv(un_aki, paste(output_dir, 'SPI_Gender_UNSD_data_3yr.csv', sep="/"))

####
# 1 Year window
####
#create this database for each year from 2004 to 2020 using a 5 year average
for (i in c(2004:2020)) {
  
  start=i-0
  end=i
  
  temp_df <- un_aki_fun(start,end)
  assign(paste('un_aki_',end, sep=""), temp_df)
}

if (exists('un_aki')) {
  rm('un_aki')
}
#now append together and save
for (i in c(2004:2020)) {
  
  temp<-get(paste('un_aki_',i, sep=""))
  
  if (!exists('un_aki')) {
    un_aki<-temp
  } else {
    un_aki<-un_aki %>%
      bind_rows(temp) %>%
      arrange(-date, iso3c)
  }
}

write_excel_csv(un_aki, path=paste(output_dir, 'SPI_Gender_UNSD_data_1yr.csv', sep="/"))

```

```{r availabilitydat}

#number of years for window
window<-5

avail_plt_df <- read_csv(paste0(output_dir, '/SPI_Gender_UNSD_data_',window,'yr.csv')) %>%
  mutate(availability=100*ind_quality) %>% #convert ind_quality measure which is 0-1 to percentage available by multiplying by 100
  filter(date==2020 & goal=="Combined") #keep just most recent year
```

Figure 1. Percentage of SDG Gender Indicators available between `r 2020-window` and 2020.  Each point corresponds to country
```{r avail_chart1}

#calculate global average
world_avg <-
  avail_plt_df %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  pull(avg)

world_p25 <- scales::comma(quantile(avail_plt_df$availability, p=0.25, na.rm=TRUE))
world_p50 <- scales::comma(quantile(avail_plt_df$availability, p=0.5, na.rm=TRUE))
world_p75 <- scales::comma(quantile(avail_plt_df$availability, p=0.75, na.rm=TRUE))

#calculate regional average
reg_avg <-
  avail_plt_df %>%
  filter(!is.na(region)) %>%
  group_by(region) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

reg_avg <- reg_avg %>%
    mutate(region=factor(region, levels=reg_avg$region)) 


#set annotatino arrows
arrows <-
  tibble(
    x1 = c(5.2, 6.62),
    x2 = c(4.6, 7),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 30)
  )




avail_plt_df %>%
  filter(!is.na(region)) %>%
  mutate(region=factor(region, levels=reg_avg$region)) %>%
  ggplot(aes(y=availability, x=region,  color=region)) +
  geom_segment(
    data=reg_avg,
    aes(x = region, xend = region,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Indicator Availability') +
  # scale_y_continuous(
  #   labels=scales::comma
  # ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 5.5, y = 60, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all countries:\n{round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 6.5, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "Regional averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )



```


Figure 1. Percentage of SDG Gender Indicators available between `r 2020-window` and 2020.  Each point corresponds to country By income group
```{r avail_chart11}

#calculate regional average
inc_avg <-
  avail_plt_df %>%
  mutate(income_level = ifelse(iso3c == "VEN", "Upper middle income", income_level)) %>%
  filter(!is.na(income_level) & income_level != "Not classified") %>%
  group_by(income_level) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg)

avail_plt_df <- avail_plt_df %>%
    mutate(income_level=factor(income_level, levels= c("High income", "Upper middle income", 
                                                       "Lower middle income", "Low income"))) 
#set annotatino arrows
arrows <-
  tibble(
    x1 = c(3.2, 1.5),
    x2 = c(2.5, 1.1),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 35)
  )

avail_plt_df %>%
  filter(!is.na(income_level)) %>%
  mutate(income_level=ordered(income_level, levels=c("High income", "Upper middle income", 
                                                       "Lower middle income", "Low income"))) %>%
  arrange(income_level) %>%
  ggplot(aes(y=availability, x=income_level,
             color=income_level)) +
  geom_segment(
    data=inc_avg,
    aes(x = income_level, xend = income_level,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Indicator Availability') +
   scale_x_discrete(
     limits=levels(avail_plt_df$income_level),
     breaks=levels(avail_plt_df$income_level)
   ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 3.35, y = 60, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all\ncountries: {round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 1.4, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "income level averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )

```

```{r availabilitydat1}


avail_plt_df <- read_csv(paste0(output_dir, '/SPI_Gender_UNSD_data_',window,'yr.csv')) %>%
  mutate(availability=100*ind_quality) %>% #convert ind_quality measure which is 0-1 to percentage available by multiplying by 100
  filter(date==2020 & goal=="Tier 1") #keep just most recent year
```

Figure 2 and 3 below break up the availability of gender related indicators into Tier 1 and Tier 2 indicators. 

Figure 2. Percentage of SDG Gender Tier 1 Indicators available between `r 2020-window` and 2020.  Each point corresponds to country
```{r avail_chart21}

#calculate global average
world_avg <-
  avail_plt_df %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  pull(avg)

world_p25 <- scales::comma(quantile(avail_plt_df$availability, p=0.25, na.rm=TRUE))
world_p50 <- scales::comma(quantile(avail_plt_df$availability, p=0.5, na.rm=TRUE))
world_p75 <- scales::comma(quantile(avail_plt_df$availability, p=0.75, na.rm=TRUE))

#calculate regional average
reg_avg <-
  avail_plt_df %>%
  filter(!is.na(region)) %>%
  group_by(region) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

reg_avg <- reg_avg %>%
    mutate(region=factor(region, levels=reg_avg$region)) 


#set annotatino arrows
arrows <-
  tibble(
    x1 = c(5.2, 6.62),
    x2 = c(4.6, 7),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 36)
  )

avail_plt_df %>%
  filter(!is.na(region)) %>%
  mutate(region=factor(region, levels=reg_avg$region)) %>%
  ggplot(aes(y=availability, x=region,  color=region)) +
  geom_segment(
    data=reg_avg,
    aes(x = region, xend = region,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG Tier 1 gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Tier 1 Indicator Availability') +
  # scale_y_continuous(
  #   labels=scales::comma
  # ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 5.5, y = 60, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all countries:\n{round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 6.5, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "Regional averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )



```


Figure 2. Percentage of SDG Gender Tier 1 Indicators available between `r 2020-window` and 2020.  Each point corresponds to country by income group
```{r avail_chart22}

#calculate regional average
inc_avg <-
  avail_plt_df %>%
    mutate(income_level = ifelse(iso3c == "VEN", "Upper middle income", income_level)) %>%
  filter(!is.na(income_level) & income_level != "Not classified") %>%
  group_by(income_level) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

avail_plt_df <- avail_plt_df %>%
    mutate(income_level=factor(income_level, levels= c("High income", "Upper middle income", 
                                                       "Lower middle income", "Low income"))) 

#set annotatino arrows
arrows <-
  tibble(
    x1 = c(3.2, 1.5),
    x2 = c(2.5, 1.1),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 37)
  )

avail_plt_df %>%
  filter(!is.na(income_level)) %>%
#  mutate(income_level=ordered(income_level, levels=c("High income", "Upper middle income", 
#                                                       "Lower middle income", "Low income"))) %>%
  arrange(income_level) %>%
  ggplot(aes(y=availability, x=income_level,  color=income_level)) +
  geom_segment(
    data=inc_avg,
    aes(x = income_level, xend = income_level,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Indicator Availability') +
   scale_x_discrete(
     limits=levels(avail_plt_df$income_level),
     breaks=levels(avail_plt_df$income_level)
   ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 3.4, y = 70, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all\ncountries: {round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 1.4, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "income level averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )

```

```{r availabilitydat2}


avail_plt_df <- read_csv(paste0(output_dir, '/SPI_Gender_UNSD_data_',window,'yr.csv')) %>%
  mutate(availability=100*ind_quality) %>% #convert ind_quality measure which is 0-1 to percentage available by multiplying by 100
  filter(date==2020 & goal=="Tier 2") #keep just most recent year
```

As shown in Figure 3, countries significantly lag in the production of Tier 2 gender indicators.

Figure 3. Percentage of SDG Gender Tier 2 Indicators available between `r 2020-window` and 2020.  Each point corresponds to country
```{r avail_chart2}

#calculate global average
world_avg <-
  avail_plt_df %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  pull(avg)

world_p25 <- scales::comma(quantile(avail_plt_df$availability, p=0.25, na.rm=TRUE))
world_p50 <- scales::comma(quantile(avail_plt_df$availability, p=0.5, na.rm=TRUE))
world_p75 <- scales::comma(quantile(avail_plt_df$availability, p=0.75, na.rm=TRUE))

#calculate regional average
reg_avg <-
  avail_plt_df %>%
  filter(!is.na(region)) %>%
  group_by(region) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

reg_avg <- reg_avg %>%
    mutate(region=factor(region, levels=reg_avg$region)) 


#set annotatino arrows
arrows <-
  tibble(
    x1 = c(5.2, 6.62),
    x2 = c(4.6, 7),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 17)
  )




avail_plt_df %>%
  filter(!is.na(region)) %>%
  mutate(region=factor(region, levels=reg_avg$region)) %>%
  ggplot(aes(y=availability, x=region,  color=region)) +
  geom_segment(
    data=reg_avg,
    aes(x = region, xend = region,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG Tier 2 gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Tier 2 Indicator Availability') +
  # scale_y_continuous(
  #   labels=scales::comma
  # ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 5.5, y = 60, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all countries:\n{round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 6.5, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "Regional averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )



```


Figure 3. Percentage of SDG Gender Tier 2 Indicators available between `r 2020-window` and 2020.  Each point corresponds to country by income group
```{r avail_chart3}

#calculate regional average
inc_avg <-
  avail_plt_df %>%
  mutate(income_level = ifelse(iso3c == "VEN", "Upper middle income", income_level)) %>%
  filter(!is.na(income_level) & income_level != "Not classified") %>%
  group_by(income_level) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

avail_plt_df <- avail_plt_df %>%
    mutate(income_level=factor(income_level, levels= c("High income", "Upper middle income", 
                                                       "Lower middle income", "Low income"))) 

#set annotatino arrows
arrows <-
  tibble(
    x1 = c(3.2, 1.5),
    x2 = c(2.5, 1.1),
    y1 = c(world_avg + 20, 16),
    y2 = c(world_avg + 2, 26)
  )

avail_plt_df %>%
  filter(!is.na(income_level)) %>%
#  mutate(income_level=ordered(income_level, levels=c("High income", "Upper middle income", 
#                                                       "Lower middle income", "Low income"))) %>%
  arrange(income_level) %>%
  ggplot(aes(y=availability, x=income_level,  color=income_level)) +
  geom_segment(
    data=inc_avg,
    aes(x = income_level, xend = income_level,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Indicator Availability') +
   scale_x_discrete(
     limits=levels(avail_plt_df$income_level),
     breaks=levels(avail_plt_df$income_level)
   ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 3.4, y = 45, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all\ncountries: {round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 1.4, y = 10, family = "Poppins", size = 4, color = "gray20",
    label = "income level\naverages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )

```

Next, the availability of gender indicators in SDG 5 on gender equality are shown. This contains both the tier 1 and tier 2 indicators.

Figure 4. Percentage of SDG 5 (Gender Equity) Indicators available between `r 2020-window` and 2020.  Each point corresponds to country

```{r availabilitydat5}

#number of years for window
window<-5

avail_plt_df5 <- read_csv(paste0(output_dir, '/SPI_Gender_UNSD_data_',window,'yr.csv')) %>%
  mutate(availability=100*ind_quality) %>% #convert ind_quality measure which is 0-1 to percentage available by multiplying by 100
  filter(date==2020 & goal=="5") #keep just most recent year



#calculate global average
world_avg <-
  avail_plt_df5 %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  pull(avg)

world_p25 <- scales::comma(quantile(avail_plt_df5$availability, p=0.25, na.rm=TRUE))
world_p50 <- scales::comma(quantile(avail_plt_df5$availability, p=0.5, na.rm=TRUE))
world_p75 <- scales::comma(quantile(avail_plt_df5$availability, p=0.75, na.rm=TRUE))

#calculate regional average
reg_avg <-
  avail_plt_df5 %>%
  filter(!is.na(region)) %>%
  group_by(region) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

reg_avg <- reg_avg %>%
    mutate(region=factor(region, levels=reg_avg$region)) 


#set annotatino arrows
arrows <-
  tibble(
    x1 = c(5.2, 6.62),
    x2 = c(4.6, 7),
    y1 = c(world_avg + 20, 20),
    y2 = c(world_avg + 2, 18)
  )




avail_plt_df5 %>%
  filter(!is.na(region)) %>%
  mutate(region=factor(region, levels=reg_avg$region)) %>%
  ggplot(aes(y=availability, x=region,  color=region)) +
  geom_segment(
    data=reg_avg,
    aes(x = region, xend = region,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG 5 availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG 5 Indicator Availability') +
  # scale_y_continuous(
  #   labels=scales::comma
  # ) +
  # scale_y_log10(
  #   labels=scales::comma
  # ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 5.5, y = 60, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all countries:\n{round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 6.5, y = 20, family = "Poppins", size = 4, color = "gray20",
    label = "Regional averages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )



```

Figure 4 by income group
```{r avail_chart4}

#calculate regional average
inc_avg <-
  avail_plt_df5 %>%
    mutate(income_level = ifelse(iso3c == "VEN", "Upper middle income", income_level)) %>%
  filter(!is.na(income_level) & income_level != "Not classified") %>%
  group_by(income_level) %>%
  summarise(avg = mean(availability, na.rm = T)) %>%
  arrange(-avg) 

avail_plt_df5 <- avail_plt_df5 %>%
    mutate(income_level=factor(income_level, levels= c("High income", "Upper middle income", 
                                                       "Lower middle income", "Low income"))) 

#set annotatino arrows
arrows <-
  tibble(
    x1 = c(3.2, 1.5),
    x2 = c(2.5, 1.1),
    y1 = c(world_avg + 20, 16),
    y2 = c(world_avg + 2, 26)
  )

avail_plt_df5 %>%
  filter(!is.na(income_level)) %>%
#  mutate(income_level=ordered(income_level, levels=c("High income", "Upper middle income", 
#                                                       "Lower middle income", "Low income"))) %>%
  arrange(income_level) %>%
  ggplot(aes(y=availability, x=income_level,  color=income_level)) +
  geom_segment(
    data=inc_avg,
    aes(x = income_level, xend = income_level,
        y = world_avg, yend = avg),
    size = 0.8
  ) +
  #geom_boxplot(aes(color=region), outlier.alpha = 0) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  #geom_point(size = 3, alpha = 0.15) +
  stat_summary(fun = mean, geom = "point", size = 5, color='black') +
  #geom_text(data=reg_avg, aes(y=avg, x=region, label=scales::comma(round(avg,1))), color="black") +
  geom_hline(aes(yintercept = world_avg), color = "gray70", size = 0.6) +
  labs(caption=str_wrap(paste0("The 25th percentile of the SDG gender availability is ",world_p25,"%. The median is ",world_p50,"% and the 75th percentile is ",world_p75,"%."),120)) +
  theme_bw() +
  coord_flip() +
  ylab('SDG Gender Indicator Availability') +
   scale_x_discrete(
     limits=levels(avail_plt_df5$income_level),
     breaks=levels(avail_plt_df5$income_level)
   ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank(),
    text = element_text(size=14) 
  ) +
  annotate( #annotations
    "text", x = 3.4, y = 45, family = "Poppins", size = 4, color = "gray20", lineheight = .9,
    label = glue::glue("Average across all\ncountries: {round(world_avg, 1)}%")
  ) +
  annotate(
    "text", x = 1.4, y = 10, family = "Poppins", size = 4, color = "gray20",
    label = "income level\naverages"
  ) +
  geom_curve( #add curves for annotatino
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3
  )

```

## Coverage Gaps for SDG Indicators requiring Gender Breakdown


```{r readgender}



#remove this dataframe if it exists
if (exists('un_sdg_gender_df')) {
  rm(un_sdg_gender_df)
}

for (series in list_df$code1) {
    
  #read in files
  if (file.exists(paste(raw_dir,'/sdg_data/',series,'_sex_disagg.csv',sep=""))) {
    temp <- read_csv(paste(raw_dir,'/sdg_data/',series,'_sex_disagg.csv',sep="")) %>%
      mutate(
        date=as.numeric(date), 
        goal=as.character(goal), 
        target=as.character(target), 
        code==as.character(code), 
        code1=as.character(code1), 
        description1=as.character(description1)
      )
    
    #   #now append it to the overall database
    if (!exists('un_sdg_gender_df')) {
      un_sdg_gender_df <- temp
    } else if (exists('un_sdg_gender_df')) {
      un_sdg_gender_df <- un_sdg_gender_df %>%
        bind_rows(temp)
    }
  }
  
}


un_sdg_gender_df <- un_sdg_gender_df %>%
  left_join(sdg_tab_merge) #add in special codes for grouping indicators (ccode)


#save the data file
  
write_excel_csv(un_sdg_gender_df, paste(output_dir, '/un_sdg_gender_disagg_df.csv',sep=""))


```


```{r gender_shape}
window <- 5
upper_year <- 2020
lower_year <- 2020-window

span <- c(lower_year:upper_year)

#create two empty datasets to merge onto
gender_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") %>% # take out the aggregates (LAC, SAR, etc)
  select(iso3c, date)

gender_disagg_empty <- gender_df_empty %>% mutate(sex='FEMALE') %>%
  bind_rows(gender_df_empty %>% mutate(sex='MALE')) %>%
  bind_rows(gender_df_empty %>% mutate(sex='BOTHSEX'))



#create database of gender indicators disaggregated by sex

  sdg_gender_disagg_df <- un_sdg_gender_df %>%
    filter(between(date,lower_year,upper_year) ) %>%
    filter(!is.na(ind_quality)) %>%
    right_join(gender_disagg_empty) %>%
    group_by(iso3c, ccode, sex) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T)) %>% #check if any values (even sub-indicators) for indicator
    filter(!is.na(ccode)) %>%
    pivot_wider(
      names_from='ccode',
      names_prefix="ccode.",
      values_from='ind_quality'
    ) %>%
  ungroup() %>%
  filter(sex %in% c("FEMALE",  "MALE","BOTHSEX" )) %>%
  mutate(across(contains("."),~if_else(is.na(.),0,.))) %>%
   group_by( sex) %>%
   summarise(across(contains("."),mean, na.rm=T)) 

#create database of gender indicators whether they exist at all

  sdg_gender_exists_df <- un_sdg_df %>%
    left_join(sdg_tab_merge) %>% #add ccode for specialized indicator grouping
    filter(between(date,lower_year,upper_year) ) %>%
    filter(!is.na(ind_quality)) %>%
    right_join(gender_df_empty) %>%
    group_by(iso3c,ccode) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T)) %>% #check if any values (even sub-indicators) for indicator
    filter(!is.na(ccode)) %>%
    pivot_wider(
      names_from='ccode',
      names_prefix="ccode.",
      values_from='ind_quality'
    ) %>%
  ungroup() %>%
  mutate(across(contains("."),~if_else(is.na(.),0,.))) %>%
  summarise(across(contains("."),mean, na.rm=T)) %>%
  mutate(sex="Any")

sdg_gender_disagg_df <- sdg_gender_disagg_df %>%
  bind_rows(sdg_gender_exists_df) 
  
```

```{r disaggplt, eval=FALSE, fig.height=6, fig.width=9, include=FALSE}

disagg_plt_df <- sdg_gender_disagg_df %>%
  pivot_longer(
      cols=contains("."),
      names_to='ccode',
      values_to='Availability'
    ) %>%
  mutate(ccode=str_remove(ccode,'ccode.'),
         ccode=as.numeric(ccode)) %>%
  left_join(list_df %>% select(ccode,code, description1, goal)) %>%
  filter(sex %in% c("FEMALE", "Any")) %>%
  mutate(sex=if_else(sex=="FEMALE","Female",sex),
         Availability=100*if_else(is.na(Availability),0,Availability)) %>%
  arrange(-as.numeric(goal), rev(code))

disagg_plt_df <- disagg_plt_df %>%
  mutate(code=factor(code,levels=unique(disagg_plt_df$code)),
         goal=factor(goal,levels=rev(unique(disagg_plt_df$goal))))
  

# New facet label names for goals variable
goals.labs <- c("SDG 1", "SDG 2", "SDG 3", "SDG 4","SDG 5","SDG 8","SDG 10", "SDG 11", "SDG 12", "SDG 13", "SDG 14", "SDG 15","SDG 16", "SDG 17")
names(goals.labs) <- c(1,2, 3, 4,5,8,10,11,12,13,14,15,16,17)
#bar graph
ggplot(disagg_plt_df, aes(x=code, y=Availability, group=sex,fill=sex)) +
  facet_wrap(~goal, scales = 'free_y',
    labeller = labeller(goal=goals.labs)) +
  geom_col(position = 'dodge') +
  geom_text(aes(label=paste0(round(Availability,1),"%")), color='black', size=4, hjust = -0.2,
            position = position_dodge(width = 1.1)) +
  xlab('SDG Indicator') +
  coord_flip() +
  theme_minimal() +
  theme(
    strip.text.x = element_text(
      size = 12)

  )+
  expand_limits(y=100)

```

For indicators that require a breakdown by sex, in several cases there are large gaps between the percentage of countries with a recent value for females and whether a value for any sex or both sexes combined exists.  For instance, while SDG indicator 1.2.1, on the proportion of population living below the national poverty line, specifies that a breakdown by sex is available.  This information is not currently available in the UN global SDG database.  Additionally, for SDG indicator 1.3.1, on Proportion of population covered by social protection floors/systems, by sex, 79.4% of countries have a recent value for any/both sexes, but only 7.8% of countries have a recent value for females.  To cite another example, for SDG indicator 4.1.1, Proportion of children and young people (a) in grades 2/3; (b) at the end of primary; and (c) at the end of lower secondary achieving at least a minimum proficiency level in (i) reading and (ii) mathematics, by sex, 62.4% of countries have a value for any/both sexes, but only 52.3% of countries have a value for females.


```{r table}

disagg_tab_df <- sdg_gender_disagg_df %>%
  pivot_longer(
      cols=contains("."),
      names_to='ccode',
      values_to='Availability'
    ) %>%
  mutate(ccode=str_remove(ccode,'ccode.'),
         ccode=as.numeric(ccode)) %>%
  right_join(list_df %>% select(ccode, code, description, goal, tier)) %>%
  filter(sex %in% c("FEMALE", "Any")) %>%
  mutate(sex=if_else(sex=="FEMALE","Sex Disaggregation Available",'Any Data Available'),
         Availability=100*round(if_else(is.na(Availability),0,Availability),3)) %>%
  arrange(as.numeric(goal), rev(code)) %>%
  distinct() %>%
  pivot_wider(
    names_from=sex,
    values_from=Availability
  ) %>%
  mutate(
    Goal=goal,
    Indicator=code,
    Tier=tier,
    Description=description
  )

table1_df <- disagg_tab_df %>%
  select(ccode, Goal, Indicator, Tier, Description, `Sex Disaggregation Available`, `Any Data Available`) %>%
  merge(table1dat, by = c("ccode","Goal", "Indicator", "Tier", "Description"), all = T) %>%
  select(Goal, Indicator, Tier, Description,`Sub-Indicators`, everything()) %>%
  select(-ccode) %>%
  arrange(as.numeric(Goal), Indicator) 

table1 <- table1_df %>%
  flextable() %>%
    add_header_lines('Table 1. SDG Indicators related to Gender') %>%
    merge_v(j='Goal') %>%
    set_formatter( `Sex Disaggregation Available` = function(x) sprintf( "%.1f%%", x ) ) %>%
    set_formatter( `Any Data Available` = function(x) sprintf( "%.1f%%", x ) ) %>%
    theme_vanilla() %>%
    add_footer_lines(values = "Source: UN."                 ) %>%
  FitFlextableToPage() %>%
    autofit()

save_as_docx(table1, path = paste(output_dir, '/table1.docx',sep=""))

```
# Comparison of Gender Data Availability and SPI Scores

Next, we assess how a country's overall statistical performance relates to the availability of gender data, and identified countries that may have strong systems overall but are underperforming on gender statistics.  To do so, we compare the availability of gender statistics to scores on the World Bank’s Statistical Performance Indicators (SPI).

The World Bank’s Statistical Performance Indicators (SPI) measure statistical performance across 174 countries.
The indicators are grouped into five pillars: (1) data use, which captures the demand side of the statistical
system; (2) data services, which looks at the interaction between data supply and demand such as the openness
of data and quality of data releases; (3) data products, which reviews whether countries report on important
indicators; (4) data sources, which assesses whether censuses, surveys, and other data sources are created; and
(5) data infrastructure, which captures whether foundations such as financing, skills, and governance needed
for a strong statistical system are in place. Within each pillar is a set of dimensions, and under each dimension
is a set of indicators to measure performance. The indicators provide a time series extending at least from 2016
to 2019 in all cases, with some indicators going back to 2004. The data for the indicators are from a variety of
sources, including databases produced by the World Bank, International Monetary Fund (IMF), United Nations
(UN), Partnership in Statistics for Development in the 21st Century (PARIS21), and Open Data Watch—and
in some cases, directly from national statistical office websites. The indicators are also summarized as an index, termed the SPI overall score,
with scores ranging from a low of 0 to a high of 100. 

There is a positive relationship between countries SPI overall scores and the availability of gender data as indicated in Figure 3.  The figure suggests that the countries statistical system, as measured by the SPI overall score, explains a little over 40% of the variation in the availability of Gender SDG Indicators.  This is based on the R-squared from a linear regression of the availability of the SDG gender indicators on the SPI overall score in 2019.  

```{r spidf}

#get overall gender data availability measure
avail_SPI_df <- read_csv(paste0(output_dir, '/SPI_Gender_UNSD_data_',window,'yr.csv')) %>%
  mutate(availability=100*ind_quality) %>% #convert ind_quality measure which is 0-1 to percentage available by multiplying by 100
  filter(date==2019 & goal=="Combined") #keep just most recent year

#read in SPI data from WDI
SPI_df <- wbstats::wb_data(indicator=c('IQ.SPI.OVRL', 'NY.GDP.PCAP.PP.CD', 'SP.POP.TOTL', 'SG.LAW.INDX'),
                           start_date = 2019)


#combine data
avail_wbstats_df <- avail_SPI_df %>%
  left_join(SPI_df) 

combined_df <- avail_wbstats_df %>%
  mutate(outcome=IQ.SPI.OVRL,
         value=availability)

eq_plot_txt_reverse(combined_df)

#combine data
combined_df2 <- avail_SPI_df %>%
  left_join(SPI_df) %>%
  filter(!is.na(IQ.SPI.OVRL)) %>% #keep the number of countries the same as the other dataframe.  SPI is the bottleneck
  mutate(outcome=log2(NY.GDP.PCAP.PP.CD),
         value=availability)

eq_plot_txt_reverse(combined_df2)

#get number of SDG indicators considered
ind_lgth<-nrow(list_df)

```

Figure 3. Plot of SPI overall score on Availability of Gender SDG Indicators

```{r spiplt3}


#plot SPI scores against availability
gend_spi_plt <-combined_df %>%
  ggplot(aes(x=IQ.SPI.OVRL, y=availability)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_spi() +
  xlab('SPI Overall Score') +
  ylab('Availability of Gender SDG Indicators (%)') +
  geom_richtext(
    aes(x = 75, y = 5,label = eq_plot_txt_reverse(combined_df), hjust=0.2)
  ) +  
  theme(legend.position = 'bottom') +
  expand_limits(x=c(0,100),
                y=c(0,100)) +
  labs(
    title='Plot of SPI overall score and Availability of Gender SDG Indicators',
    caption=str_wrap('Source: SPI Overall Score from the World Development Indicators (IQ.SPI.OVRL).  The availability of Gender SDG Indicators based on authors calculations based on the UN Global SDG Database.',100)
  )

gend_spi_plt

```

```{r spiplt2}


#plot SPI scores against availability
gend_gdp_plt <-combined_df2 %>%
  ggplot(aes(x=NY.GDP.PCAP.PP.CD, y=availability)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_spi() + 
  scale_x_log10(labels=scales::comma) +
  xlab('GDP per capita, PPP (current international $), logged') +
  ylab('Availability of Gender SDG Indicators (%)') +
  geom_richtext(
    aes(y = 87, x = 40000,label = eq_plot_txt_reverse(combined_df2), hjust=0.2)
  ) +  
  theme(legend.position = 'bottom') +
  expand_limits(y=c(0,100)) +
  labs(
    title='Plot of GDP per capita and Availability of Gender SDG Indicators',
    caption=str_wrap('Source: GDP per capita from the World Development Indicatrs (NY.GDP.PCAP.PP.CD).  The availability of Gender SDG Indicators based on authors calculations based on the UN Global SDG Database.',100)
  )

gend_gdp_plt

```
To highlight countries where these relationships do not hold as well, the next figure shows the 15 countries that most over-perform and the 15 countries that most under-perform on the availability of gender data compared to their SPI overall score.  

To produce this figure, we use OLS regression to estimate a linear model of the availability of gender SDG data on the SPI overall score in 2019. The residual can be interpreted as the difference between the country’s availability of gender data and the expected availability given their SPI overall score. Countries with values of the residual greater than zero are over-performing based on their SPI overall score and countries with residuals less than zero are under-performing. 

```{r}
#get top 10 and bottom 10 over performers compared to gdp and hci

## GDP
#regress SPI on gdp

indicator <- 'availability'

form <- paste(indicator, " ~ IQ.SPI.OVRL", sep="")

m_spi <- lm(form , data = combined_df) 

gender_overperformers_df <- combined_df %>%
  modelr::add_residuals(m_spi) %>%
  modelr::add_predictions(m_spi) %>%
  arrange(-resid) %>%
  head(15)

#get top performing country
top_outcome<-round(gender_overperformers_df$value[1],1)
top_pred<-round(as.numeric(gender_overperformers_df$pred[1]),1)
top_res<-round(as.numeric(gender_overperformers_df$resid[1]),1)
top_country<-gender_overperformers_df$country[1]

gender_underperformers_df <- combined_df %>%
  modelr::add_predictions(m_spi) %>%
  modelr::add_residuals(m_spi) %>%
  arrange(resid) %>%
  head(15)




gender_overperformers_plot <-  gender_overperformers_df %>%
  bind_rows(gender_underperformers_df) %>%
  arrange(resid) %>%
  mutate(n_ind=resid*ind_lgth/100)#transform data to number of additional indicators
```


The data is presented in two ways.  First, the number of additional SDG indicators compared to the expected number based on the SPI overall score is shown.  This is calculated by taking the residual from the regression described above and multiplying by the number of Gender related SDG indicators (`r ind_lgth` indicators).  To give a specific example, `r top_country` reported on `r top_outcome`% of the SDG gender indicators.  Based on the SPI overall score of the country, it was expected to produce `r top_pred` SDG gender indicators.  This resulted in a `r top_res` percentage point difference in the percentage of SDG gender indicators available. By multiplying this by the total number of SDG indicators on gender (`r ind_lgth` indicators), we get the additional SDG indicators compared to expected of `r round(top_res*ind_lgth/100,0)`.

In the second appoach, the data is presented as the percentage increase/decrease in SDG indicators available compared to the expected amount.  To take `r top_country` as an example, the percentage increase in SDG indicators compared to expected is 100 times `r top_res` divided by `r top_pred` or `r round(top_res/top_pred,2)`.

Figure 4: Top 15 Over/Under-Performers on Availability of Gender SDG Indicators compared to the SPI Overall Score in 2019
```{r overperformers}



gender_overperformers_plot <- gender_overperformers_plot %>%
  mutate(country=factor(country, levels=unique(gender_overperformers_plot$country)),
         group=if_else(n_ind>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=n_ind, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=n_ind), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="Gender SDG Availability",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("Number of Additional SDG Indicators Compared to Expected") +
  ggtitle("Gender SDG Availability",
          subtitle = 'Number of Additional SDG Indicators than Expected Based on SPI Score')





gender_overperformers_plot + 
  plot_annotation(
    # title='Top 15 Over/Under-Performers on SPI overall score compared to GDP per capita and Human Capital Index',
                  caption=str_wrap('Over and under performers calculated for Availability of Gender Indicators by using OLS regression of Availability on SPI overall score in 2019 and calculting residuals from this regression.  ',100)
                  )
```


Figure 4b: Top 15 Over/Under-Performers on Availability of Gender SDG Indicators compared to the SPI Overall Score in 2019
```{r overperformersb}

#get top 10 and bottom 10 over performers compared to gdp and hci

## GDP
#regress SPI on gdp

indicator <- 'availability'

form <- paste(indicator, " ~ IQ.SPI.OVRL", sep="")

m_spi <- lm(form , data = combined_df) 

gender_overperformers_df <- combined_df %>%
  modelr::add_residuals(m_spi) %>%
  modelr::add_predictions(m_spi) %>%
  mutate(dist=100*resid/pred) %>%
  arrange(-dist) %>%
  head(15)

gender_underperformers_df <- combined_df %>%
  modelr::add_residuals(m_spi) %>%
  modelr::add_predictions(m_spi) %>%
  mutate(dist=100*resid/pred) %>%
  arrange(dist) %>%
  head(15)


gender_overperformers_plot <-  gender_overperformers_df %>%
  bind_rows(gender_underperformers_df) %>%
  arrange(dist) 

gender_overperformers_plot <- gender_overperformers_plot %>%
  mutate(country=factor(country, levels=unique(gender_overperformers_plot$country)),
         group=if_else(dist>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=dist, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=dist), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="Gender SDG Availability",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("Percentage Difference from Expected Based on SPI Overall Score") +
  ggtitle("Gender SDG Availability",
          subtitle = 'Difference from Expected shown as Percent of Predicted Value')





gender_overperformers_plot + 
  plot_annotation(
    # title='Top 15 Over/Under-Performers on SPI overall score compared to GDP per capita and Human Capital Index',
                  caption=str_wrap('Over and under performers calculated for Availability of Gender Indicators by using OLS regression of Availability on SPI overall score in 2019 and calculting residuals from this regression.  ',100)
                  )
```

As discussed above, a simple OLS regresion of the availability of gender SDG indicators on the SPI overall score, indicates that around 40% of the variation in the availability of gender SDG indicators is explained by the statistical performance of a country, leaving around 60% unexplained.  Below a discussion will be given of other factors that may explain the availability of gender SDG indicators, including the region, income level, population size, and level of female empowerment in a country as measured by the [Women, Business, and the Law index](https://wbl.worldbank.org/en/wbl).  

Table. Regression of Availability of SDG Indicators on Explanatory Variables.  Data from year 2019.
```{r model}


avail_wbstats_reg_df <- avail_wbstats_df %>%
  filter(!(is.na(IQ.SPI.OVRL) | is.na(NY.GDP.PCAP.PP.CD) | is.na(SP.POP.TOTL) | is.na(SG.LAW.INDX)))

models <- list(
  
'All Explanatory Variables Included' = feols(availability ~  IQ.SPI.OVRL + log(NY.GDP.PCAP.PP.CD)  + log(SP.POP.TOTL) + SG.LAW.INDX + region  , data=avail_wbstats_reg_df, se='hetero'),
'SPI Only' = feols(availability ~  IQ.SPI.OVRL , data=avail_wbstats_reg_df, se='hetero'),
'SPI Excluded' = feols(availability ~   log(NY.GDP.PCAP.PP.CD)  + log(SP.POP.TOTL) + SG.LAW.INDX + region , data=avail_wbstats_reg_df, se='hetero'),
'Region Only' = feols(availability ~   region  , data=avail_wbstats_reg_df, se='hetero'),
'Region Excluded' = feols(availability ~  IQ.SPI.OVRL + log(NY.GDP.PCAP.PP.CD)  + log(SP.POP.TOTL) + SG.LAW.INDX  , data=avail_wbstats_reg_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("IQ.SPI.OVRL" = "SPI Overall Score",
                             "log(NY.GDP.PCAP.PP.CD)" = "Log GDP per capita",
                             "log(NY.GDP.PCAP.PP.CD^2)" = "Log GDP per capita Squared",
                             "region"="Region",
                             "log(SP.POP.TOTL)"="Log Population",
                             "SG.LAW.INDX" = "Women Business and the Law Index Score (scale 1-100)"
                             ),
             notes="",
             gof_map = gm,
             escape = FALSE             
             )

```


# Data Sources for Gender Indicators

In what will follow, the most common data sources for each of the SDG indicators in Table 1 will be discussed.  This can provide some guidance on the types of data sources that are typically used to report on these indicators, and reveal gaps that may exists for specific countries.  Data sources are based on the metadata in the [UN Global SDG Indicator Database](https://unstats.un.org/sdgs/indicators/database/).^[Data was pulled from the UN Global SDG Indicators database on July 19, 2021.]

```{r sources, eval=FALSE, cache=TRUE, include=FALSE}

#sdg raw data read function
read_sdg_data  <- function(series) {
  
  read_csv(paste(raw_dir,'/sdg_data/raw/',series,'_raw.csv',sep="")) %>%
    group_by(Source) %>%
    summarise(n=n()) %>%
    arrange(n) %>%
    mutate(
      order=row_number(),
      Source=factor(Source,levels=Source)) 
  
}

#create new dataset containing a list of data sources for each indicator
sources_df <- list_df %>%
  filter(!is.na(code1)) %>%
  mutate(data=map(
    code1,read_sdg_data
  )) 
  
save(sources_df, file = paste(raw_dir,'/sdg_data/SDG_sources.Rdata',sep=""))

source_df_long <- sources_df %>%
  unnest(data)
```


```{r loaddata}


load(paste(raw_dir,'/sdg_data/SDG_sources.Rdata',sep=""))

source_df_long <- sources_df %>%
  unnest(data)

```


```{r categorize}

#use key words to categorize sources
sources_categorized_df <- source_df_long %>%
  mutate(
        cap_source=str_to_title(Source),
        data_type=case_when(
            grepl('Demographic|DHS|Salud|Health Survey', Source)  ~ "Demographic and Health Survey",
            grepl('Multiple Indicator|MICS', Source) ~ "MICS",
            grepl('Living Standard|LSMS|Integrated|Hogares|hogares|Household Survey|Living Conditions|Household Budget|HIES|HS|Household Income|Poverty|Household Socio-Economic Survey', Source) ~ "Household Survey",
            grepl('Administrative|ADM|Register|Registration|Vital Statistics', Source) ~ "Administrative Records",
            grepl('NLA|TIMSS|PIRLS|National Learning|PISA|NAEP|EGRA|EGMA|PASEC|SACMEQ|Natinoal Assessment|LLECE', Source) ~ "Learning Assessment",
            grepl('Labour|Labor|Earnings|LFS|Employment|Salaries|Wages', Source) ~ "Labor Force Survey",
            grepl('Establishment Survey|ES -', Source) ~ "Establishment Survey",    
            grepl('Census|censo|recensement', Source) ~ "Census",
            grepl('Time Use|Time use|Use Of Time|Time', Source) ~ "Time Use Survey",
            grepl('Statistical Yearbook|NSO|CSO|National Statistic|Ministry|Statistical Office|Bureau Of Statistics', Source) ~ "National Statistical Office",
            grepl('World Bank|UNAIDS|UNESCO|ILO|WHO|World Health Organization|World Development Indicators|World Inequality Database|Eurostat|UNSD', Source) ~ "International Organization",
            TRUE ~ "Other")
    )

sources_explained <- sources_categorized_df %>%
  group_by(data_type, code, code1, description, description1) %>%
  summarise(n=sum(n),
            `Example Source`=first(Source)) %>%
  left_join(un_sdg_meta_wide, by = "code1") %>%
  arrange(code) 

  
sources_explained %>%
  select(code, code1, description, data_type, n, source_share, `Example Source`) %>%
  rename('Indicator' = 'code',
         'Code' = 'code1',
         'Description' = 'description',
         'Data Type' = 'data_type',
         'Number of country-year surveys of the type' = 'n',
         'Nature of data classification' ='source_share') %>%
  flextable() %>%
    add_header_lines('Table Annex. Data Sources for SDG Gender Indicators') %>%
    merge_v(j='Indicator') %>%
    theme_vanilla() #%>%
#  FitFlextableToPage() %>%`
#    autofit()



save_as_docx(sources_explained, path = paste(output_dir, '/tableannex.docx',sep=""))


```
Now show a table for  the top 10 for each indicator.  In some cases, the sources are unique for each country.  In that case, a set of 5 are chosen.

```{r souceplot, eval=FALSE, fig.height=8, include=FALSE}


#use map to loop through SDG indicators and plot top 5 data sources for each indicator
sources_df_plt <- sources_df %>%
  mutate(plot=map2(
    .x=data,
    .y=description1,
    ~ggplot(data=.x, aes(x=n,y=Source)) +
      geom_col() +
      #geom_text(aes(x=-2, label=.), color='black', size=3.2, hjust = 1) +
      theme_minimal() +
      scale_y_discrete(labels = function(x) str_wrap(as.character(x), width = 20)) +
      theme(
        axis.title.y = element_blank(),
        legend.position = 'none',
      ) +
      labs(
        caption="Source: UN Global SDG Database. "
      ) +
      ggtitle(str_wrap(paste0("Top 5 Data Sources for ",.y),70))
    
  
  ))

print(sources_df_plt$plot)

```


```{r sourcetab}


#use map to loop through SDG indicators and plot top 5 data sources for each indicator
sources_df_tab_list <- sources_df$description1 

sources_tab_fun <- function(variables) {

  sdg_code<- list_df[which(list_df$description1==variables),]$code
  
   sources_explained %>%
     ungroup() %>%
    filter(description1==variables) %>%
    rename(Source=data_type) %>%
    select(Source, n, `Example Source`) %>%
    rename(`Number of Times Used`=n) %>%
    flextable() %>% 
    add_header_lines(variables) %>%
    add_header_lines(paste0("Indicator sources for SDG ", sdg_code,". ")) %>% 
    theme_vanilla() %>% 
    add_footer_lines(values = "Source: UN Global SDG Database.") %>% 
    autofit()
  
    
  

}
 
sources_tab_fun(sources_df_tab_list[1])
# for (i in c(1:length(sources_df_tab_list))) {
#   sources_tab_fun(sources_df_tab_list[i])
# 
# }
```

```{r} 

```

```{r} 
sources_tab_fun(sources_df_tab_list[2])
```

```{r} 

sources_tab_fun(sources_df_tab_list[3])
```

```{r} 
sources_tab_fun(sources_df_tab_list[4])
```

```{r} 
sources_tab_fun(sources_df_tab_list[5])
```

```{r} 
sources_tab_fun(sources_df_tab_list[6])
```

```{r} 
sources_tab_fun(sources_df_tab_list[7])
```

```{r} 
sources_tab_fun(sources_df_tab_list[8])
```

```{r} 

sources_tab_fun(sources_df_tab_list[9])
```

```{r} 
sources_tab_fun(sources_df_tab_list[10])
```

```{r} 
sources_tab_fun(sources_df_tab_list[11])
```

```{r} 
sources_tab_fun(sources_df_tab_list[12])
```

```{r} 
sources_tab_fun(sources_df_tab_list[13])
```

```{r} 
sources_tab_fun(sources_df_tab_list[14])
```

```{r} 
sources_tab_fun(sources_df_tab_list[15])
```

```{r} 
sources_tab_fun(sources_df_tab_list[16])
```

```{r} 
sources_tab_fun(sources_df_tab_list[17])
```

```{r} 
sources_tab_fun(sources_df_tab_list[18])
```

```{r} 
sources_tab_fun(sources_df_tab_list[19])
```

```{r} 
sources_tab_fun(sources_df_tab_list[20])
```

```{r} 
sources_tab_fun(sources_df_tab_list[21])
```

```{r} 
sources_tab_fun(sources_df_tab_list[22])
```

```{r} 
sources_tab_fun(sources_df_tab_list[23])
```

```{r} 
sources_tab_fun(sources_df_tab_list[24])
```

```{r} 
sources_tab_fun(sources_df_tab_list[25])
```

```{r} 
sources_tab_fun(sources_df_tab_list[26])
```

```{r} 
sources_tab_fun(sources_df_tab_list[27])
```

```{r} 
sources_tab_fun(sources_df_tab_list[28])
```

```{r} 
sources_tab_fun(sources_df_tab_list[29])
```

```{r} 
sources_tab_fun(sources_df_tab_list[30])
```


```{r} 
sources_tab_fun(sources_df_tab_list[31])
```

```{r} 
sources_tab_fun(sources_df_tab_list[32])
```

```{r} 
sources_tab_fun(sources_df_tab_list[33])
```

```{r} 
sources_tab_fun(sources_df_tab_list[34])
```

```{r} 
sources_tab_fun(sources_df_tab_list[35])
```

```{r} 
sources_tab_fun(sources_df_tab_list[36])
```

```{r} 
sources_tab_fun(sources_df_tab_list[37])
```

```{r} 
sources_tab_fun(sources_df_tab_list[38])
```

```{r} 
sources_tab_fun(sources_df_tab_list[39])
```

```{r} 
sources_tab_fun(sources_df_tab_list[40])
```

```{r} 
sources_tab_fun(sources_df_tab_list[41])
```

```{r} 
sources_tab_fun(sources_df_tab_list[42])
```

```{r} 
sources_tab_fun(sources_df_tab_list[43])
```

```{r} 
sources_tab_fun(sources_df_tab_list[44])
```

```{r} 
sources_tab_fun(sources_df_tab_list[45])
```

```{r} 
sources_tab_fun(sources_df_tab_list[46])
```

```{r} 
sources_tab_fun(sources_df_tab_list[47])
```

```{r} 
sources_tab_fun(sources_df_tab_list[48])
```

```{r} 
sources_tab_fun(sources_df_tab_list[49])
```

```{r} 
sources_tab_fun(sources_df_tab_list[50])
```


```{r} 
sources_tab_fun(sources_df_tab_list[51])
```

```{r} 
sources_tab_fun(sources_df_tab_list[52])
```

```{r} 
sources_tab_fun(sources_df_tab_list[53])
```

```{r} 
sources_tab_fun(sources_df_tab_list[54])
```

```{r} 
sources_tab_fun(sources_df_tab_list[55])
```

```{r} 
sources_tab_fun(sources_df_tab_list[56])
```

```{r} 
sources_tab_fun(sources_df_tab_list[57])
```

```{r} 
sources_tab_fun(sources_df_tab_list[58])
```

```{r} 
sources_tab_fun(sources_df_tab_list[59])
```

```{r} 
sources_tab_fun(sources_df_tab_list[60])
```

```{r} 
sources_tab_fun(sources_df_tab_list[61])
```

```{r} 
sources_tab_fun(sources_df_tab_list[62])
```

```{r} 
sources_tab_fun(sources_df_tab_list[63])
```

```{r} 
sources_tab_fun(sources_df_tab_list[64])
```

```{r} 
sources_tab_fun(sources_df_tab_list[65])
```

```{r} 
sources_tab_fun(sources_df_tab_list[66])
```

```{r} 
sources_tab_fun(sources_df_tab_list[67])
```

```{r} 
sources_tab_fun(sources_df_tab_list[68])
```

```{r} 
sources_tab_fun(sources_df_tab_list[69])
```

```{r} 
sources_tab_fun(sources_df_tab_list[70])
```

# Annex

## Data Availability Including Modelled Data



For each indicator, we will produce a value for each country with the following coding scheme:    

  * **1 Point**: Indicator exists and the value is based on the **country**, **country data adjusted**, **estimated**, **modeled or Global Monitoring** data    
  * **0 Points**: Indicator **does not exists**
  
We give countries no credit for modeled data, because the country did not produce indicators in a form that was directly usable for reporting on an SDG indicator.
  
When we average over all indicators in a goal to get a score, we compute a 5 year moving average to avoid year to year variability in reporting for SDGs.  The overall score for an SDG is then the 5 year average of the percentage of indicator values based on **country**, **country data adjusted**, or **estimated or Global Monitoring** data that were available for the SDG.


```{r savemod, echo=FALSE, message=FALSE, warning=FALSE}

country_metadata <- wbstats::wb_countries() %>%
  filter(region!="Aggregates")

#remove this dataframe if it exists
if (exists('un_sdg_df_modelled')) {
  rm(un_sdg_df_modelled)
}

for (series in list_df$code1) {
    
  #read in files
  if (file.exists(paste(raw_dir,'/sdg_data/',series,'_modelled.csv',sep=""))) {
    temp <- read_csv(paste(raw_dir,'/sdg_data/',series,'_modelled.csv',sep="")) %>%
      mutate(
        date=as.numeric(date), 
        goal=as.character(goal), 
        target=as.character(target), 
        code==as.character(code), 
        code1=as.character(code1), 
        description1=as.character(description1)
      )
    
    #   #now append it to the overall database
    if (!exists('un_sdg_df_modelled')) {
      un_sdg_df_modelled <- temp
    } else if (exists('un_sdg_df_modelled')) {
      un_sdg_df_modelled <- un_sdg_df_modelled %>%
        bind_rows(temp)
    }
  }
  
}


#read in OECD data for updates based on OECD database
oecd_df <- read_csv(paste(raw_dir,'/oecd_data/OECD_data_scored.csv', sep=""))

un_sdg_df_modelled <- un_sdg_df_modelled %>%
  mutate(goal=as.numeric(goal)) %>%
  left_join(oecd_df) %>%
  mutate(goal=as.character(goal)) %>%
  mutate(ind_quality=if_else(ind_quality.oecd>ind_quality,ind_quality.oecd,ind_quality, ind_quality )) #replace value with OECD value if it exists

#save the data file
  
write_excel_csv(un_sdg_df_modelled, paste(output_dir, '/un_sdg_df_modelled.csv',sep=""))


```


```{r readgendermod}



#remove this dataframe if it exists
if (exists('un_sdg_gender_df_modelled')) {
  rm(un_sdg_gender_df)
}

for (series in list_df$code1) {
    
  #read in files
  if (file.exists(paste(raw_dir,'/sdg_data/',series,'_sex_disagg_modelled.csv',sep=""))) {
    temp <- read_csv(paste(raw_dir,'/sdg_data/',series,'_sex_disagg_modelled.csv',sep="")) %>%
      mutate(
        date=as.numeric(date), 
        goal=as.character(goal), 
        target=as.character(target), 
        code==as.character(code), 
        code1=as.character(code1), 
        description1=as.character(description1)
      )
    
    #   #now append it to the overall database
    if (!exists('un_sdg_gender_df_modelled')) {
      un_sdg_gender_df_modelled <- temp
    } else if (exists('un_sdg_gender_df_modelled')) {
      un_sdg_gender_df_modelled <- un_sdg_gender_df_modelled %>%
        bind_rows(temp)
    }
  }
  
}


un_sdg_gender_df_modelled <- un_sdg_gender_df_modelled %>%
  left_join(sdg_tab_merge) #add in special codes for grouping indicators (ccode)


#save the data file
  
write_excel_csv(un_sdg_gender_df_modelled, paste(output_dir, '/un_sdg_gender_df_modelled.csv',sep=""))

```


```{r gender_shapemod}
window <- 5
upper_year <- 2020
lower_year <- 2020-window

span <- c(lower_year:upper_year)

#create two empty datasets to merge onto
gender_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") %>% # take out the aggregates (LAC, SAR, etc)
  select(iso3c, date)

gender_disagg_empty <- gender_df_empty %>% mutate(sex='FEMALE') %>%
  bind_rows(gender_df_empty %>% mutate(sex='MALE')) %>%
  bind_rows(gender_df_empty %>% mutate(sex='BOTHSEX'))



#create database of gender indicators disaggregated by sex

  sdg_gender_disagg_df <- un_sdg_gender_df_modelled %>%
    filter(between(date,lower_year,upper_year) ) %>%
    filter(!is.na(ind_quality)) %>%
    right_join(gender_disagg_empty) %>%
    group_by(iso3c, ccode, sex) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T)) %>% #check if any values (even sub-indicators) for indicator
    filter(!is.na(ccode)) %>%
    pivot_wider(
      names_from='ccode',
      names_prefix="ccode.",
      values_from='ind_quality'
    ) %>%
  ungroup() %>%
  filter(sex %in% c("FEMALE",  "MALE","BOTHSEX" )) %>%
  mutate(across(contains("."),~if_else(is.na(.),0,.))) %>%
   group_by( sex) %>%
   summarise(across(contains("."),mean, na.rm=T)) 

#create database of gender indicators whether they exist at all

  sdg_gender_exists_df <- un_sdg_df_modelled  %>%
    left_join(sdg_tab_merge) %>% #add ccode for specialized indicator grouping
    filter(between(date,lower_year,upper_year) ) %>%
    filter(!is.na(ind_quality)) %>%
    right_join(gender_df_empty) %>%
    group_by(iso3c,ccode) %>%
    summarise(ind_quality=max(ind_quality, na.rm=T)) %>% #check if any values (even sub-indicators) for indicator
    filter(!is.na(ccode)) %>%
    pivot_wider(
      names_from='ccode',
      names_prefix="ccode.",
      values_from='ind_quality'
    ) %>%
  ungroup() %>%
  mutate(across(contains("."),~if_else(is.na(.),0,.))) %>%
  summarise(across(contains("."),mean, na.rm=T)) %>%
  mutate(sex="Any")

sdg_gender_disagg_df <- sdg_gender_disagg_df %>%
  bind_rows(sdg_gender_exists_df) 
  
```


```{r tablemod}

disagg_tab_df <- sdg_gender_disagg_df %>%
  pivot_longer(
      cols=contains("."),
      names_to='ccode',
      values_to='Availability'
    ) %>%
  mutate(ccode=str_remove(ccode,'ccode.'),
         ccode=as.numeric(ccode)) %>%
  right_join(list_df %>% select(ccode, code, description, goal, tier)) %>%
  filter(sex %in% c("FEMALE", "Any")) %>%
  mutate(sex=if_else(sex=="FEMALE","Sex Disaggregation Available",'Any Data Available'),
         Availability=100*round(if_else(is.na(Availability),0,Availability),3)) %>%
  arrange(as.numeric(goal), rev(code)) %>%
  distinct() %>%
  pivot_wider(
    names_from=sex,
    values_from=Availability
  ) %>%
  mutate(
    Goal=goal,
    Indicator=code,
    Tier=tier,
    Description=description
  )

table1_modelled_df <- disagg_tab_df %>%
  select(ccode, Goal, Indicator, Tier, Description, `Sex Disaggregation Available`, `Any Data Available`) %>%
  merge(table1dat, by = c("ccode","Goal", "Indicator", "Tier", "Description"), all = T) %>%
  select(Goal, Indicator, Tier, Description,`Sub-Indicators`, everything()) %>%
  select(-ccode) %>%
  arrange(as.numeric(Goal), Indicator) 

table1_modelled <- table1_modelled_df %>%
  flextable() %>%
    add_header_lines('Table 1b. SDG Indicators related to Gender - Modelled data included') %>%
    merge_v(j='Goal') %>%
    set_formatter( `Sex Disaggregation Available` = function(x) sprintf( "%.1f%%", x ) ) %>%
    set_formatter( `Any Data Available` = function(x) sprintf( "%.1f%%", x ) ) %>%
    theme_vanilla() %>%
    add_footer_lines(values = "Source: UN."                 ) %>%
  FitFlextableToPage() %>%
    autofit()

save_as_docx(table1_modelled, path = paste(output_dir, '/table1_modelled.docx',sep=""))

#Combine with oringal table 1 in excel
table1_combined <- table1_df %>%
  left_join(table1_modelled_df %>% 
              rename(`Sex Disaggregation Available (w/ Modelled)`=`Sex Disaggregation Available`, 
                     `Any Data Available (w/ Modelled)`=`Any Data Available`))

write_excel_csv(table1_combined, paste(output_dir, '/table1_combined.csv',sep=""))
```
